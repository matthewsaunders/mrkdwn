# Overview

The mrkdwn gem converts markdown text to html. It does so using two main comoponents:

1. Parser
2. Renderer

This can be seen my looking at `Mrkdwn#html`.

```ruby
def self.toHtml(markdown)
  tokens = Mrkdwn::Parser.parse(markdown)
  html = Mrkdwn::Renderer.render(tokens)
  html
end
```

## Parser

The parser take markdown input and splits the input into an array of characters. It then loops through these characters one by one until it hits the EOF turning the input into tokens that represent pieces of the final HTML document.

### Interesting features

#### Block vs Inline parsing

Markdown elements are either block elements (i.e. text or headings), or inline elements (i.e. strong text). Inline elements can be contained in both block and inline elements, so recursive parser calls are made on the contents of most elements. The base element is most cases is the `RAW_TEXT` token. This is, not surprisingly, just text.

#### Unclosed inline tokens

It is possible to have an unclosed inline element (i.e. `*text`). In this case, the parser should treat this unclosed token as text. However, the parser doesnt find out the token is unclosed until it hits a condition that indicates we are done with the token. To overcome this, there is a mechanism to "rewind" to the starting positiion before parsing of this block of markdown started and replay it using the `#parse_text` method instead of `#parse_em` in this instance.

#### Bulk of logic is in `#parse_text`

Most of the thinking exists in the `#parse_text` method. When parsing text, text can

- Be on multiple consecutive lines
- Contain inline tokens (i.e. anchor tags)

## Renderer

The renderer takes the list of nodes generated by the parser and renders them into an HTML document.

### Interesting features

#### Spacing

How to place space between tokens is tricky. If you have an inline token, do you always want spaces on either side of that token? It depends. Consider the following examples.

```
# example A
A link to [github](https://github.com/).

=> <p>A link to <a href="https://github.com/">github</a>.</p>

# example B
A *really* like github.

=> <p>A <em>really</em> like github.</p>
```

In example A, we do want a space before the anchor tag, but not after. We didn't write a space inbetween our anchor tag and the period, so we don't want it to render a space there. But in example B, we do want spaces on either side of our `<em>` tag. Context matters, so we have to do some thinking when rendering to account for context.

#### Recursive calls

Similar to the parser, the renderer also calls itself recursively to parse the inner content of some tags. When this happens, it lets the renderer with `inline_context = true`. This adds context used to make decisions. Mainly whether or not to add an ending new line to the HTML document fragment.

#### Only renders fragments

This gem only renders HTML document fragments. It does not render an entire document including `<head>` and `<body>` tags.
